// ============================================================
// Shared constants and utilities for Tiul ear training apps
// Ported from Python core/constants.py
// ============================================================

// Scale degrees for each key, ordered by tiul weight priority:
//   1  5  3  2  4  6  7  4+  7-  3-  6-  1+  2-
const KEY_DEGREES = {
    'C':  ['c','g','e','d','f','a','b','f#','b-','e-','a-','c#','d-'],
    'G':  ['g','d','b','a','c','e','f#','c#','f','b-','e-','g#','a-'],
    'D':  ['d','a','f#','e','g','b','c#','g#','c','f','b-','d#','e-'],
    'A':  ['a','e','c#','b','d','f#','g#','d#','g','c','f','a#','b-'],
    'E':  ['e','b','g#','f#','a','c#','d#','a#','d','g','c','e#','f'],
    'B':  ['b','f#','d#','c#','e','g#','a#','e#','a','d','g','b#','c'],
    'F#': ['f#','c#','a#','g#','b','d#','e#','b#','e','a','d','f##','g'],
    'C#': ['c#','g#','e#','d#','f#','a#','b#','f##','b','e','a','c##','d'],
    'F':  ['f','c','a','g','b-','d','e','b','e-','a-','d-','f#','g-'],
    'B-': ['b-','f','d','c','e-','g','a','e','a-','d-','g-','b','c-'],
    'E-': ['e-','b-','g','f','a-','c','d','a','d-','g-','c-','e','f-'],
    'A-': ['a-','e-','c','b-','d-','f','g','d','g-','c-','f-','a','b--'],
    'D-': ['d-','a-','f','e-','g-','b-','c','g','c-','f-','b--','d','e--'],
    'G-': ['g-','d-','b-','a-','c-','e-','f','c','f-','b--','e--','g','a--'],
    'C-': ['c-','g-','e-','d-','f-','a-','b-','f','b--','e--','a--','c','d--']
};

const KEY_ORDER = ['C','G','D','A','E','B','F#','C#','F','B-','E-','A-','D-','G-','C-'];

const TIUL_WEIGHTS_DEFAULT = [5, 4, 3, 2, 2, 2, 3, 1, 1, 1, 1, 1, 1];

// Normalized sample sequences (indices into KEY_DEGREES arrays)
const SAMPLES = [
    [0,1,0,0,5,4,3,6,0,2,4,5,1,5,6,3,0,2,6,2,4,1,5,6,4,2,3,1,0,6,8,5,1,2,1,4,2,3,5,1,6,0,2,3,0,1,4,2,0,6,8,5,2,3,4,6,0,9,3,7,1,8,5,1,6,5,3,1,5,3,1,6,3,7,1,10,1,6,0,7,1,9,3,0,7,4,2,1,5,6,1,0,4,7,1,3,4,2,9,3,6,0,1,7,1,1,1,0,0],
    [0,1,0,6,5,1,4,2,1,3,2,0,3,2,4,2,3,6,1,0,1,3,1,2,1,4,3,6,0,6,5,4,2,3,1,4,3,1,4,6,3,0,2,5,6,0,5,7,1,7,1,4,2,6,0,2,5,6,3,0,7,1,6,5,2,1,3,1,0,6,5,3,6,2,5,1,7,1,0,6,7,1,2,3,0,1,6,1,5,6,0,3,2,7,6,8,5,10,1,7,4,2,9,4,2,0,6,1,5,6,0,1,5,6,3,0,2,7,1,4,2,9,3,6,7,1,4,2,3,1,0,0,6,5,1,0,5,1,4,3,1,0,1,0,1,0,0,3,2,0,1,4,2,3,1,0,6,5,1,7,1,2,4,6,0,2,5,1,2,0,6,8,5,10,1,7,1,4,6,1,2,3,0,1,0,5,4,3,4,6,3,1,5,6,3,0,0,0],
    [0,3,1,2,5,3,1,5,6,0,0,6,8,5,4,5,1,2,5,0,4,2,3,0,3,1,0,3,6,0,5,7,1,4,2,3,5,6,2,3,0,2,3,0,5,4,6,1,0,5,3,2,4,6,0,8,5,1,0,3,2,5,1,4,0,8,5,10,1,2,4,3,1,4,5,6,5,1,2,0,5,2,0,5,6,0,2,5,6,0,5,1,2,4,3,2,5,1,0,3,1,4,2,0,6,8,5,10,1,7,1,4,3,2,6,3,4,2,1,0],
    [0,1,4,3,2,4,3,6,1,5,6,0,1,0,6,1,5,1,2,4,3,1,5,6,0,2,3,6,3,0,5,0,6,1,5,7,1,2,3,0,5,6,0,3,5,6,1,4,3,1,4,0,1,4,0,6,3,5,3,1,5,6,0,9,3,1,7,5,10,1,2,0,11,3,2,5,6,0,3,2,5,6,0,1,7,1,4,0,3,9,3,1,5,3,2,5,6,0,4,5,6,0,1,0,3,6,1,5,6,1,2,9,3,11,0,5,10,1,4,2,8,5,10,1,6,0],
    [0,1,6,3,0,7,1,2,3,4,6,0,2,5,3,1,6,4,2,3,1,2,3,0,2,3,4,6,0,1,4,3,5,1,2,0,6,5,1,0,6,7,5,1,2,3,4,6,2,5,3,1,0,2,3,8,5,4,1,3,1,5,0,3,1,7,1,6,0,7,10,1,5,10,1,2,6,5,2,7,1,0,11,3,6,1,4,2,6,0,0],
    [0,1,9,3,0,9,5,6,1,2,3,0,2,9,3,1,8,5,3,2,0,1,0,1,3,1,2,1,4,2,3,1,5,6,1,2,3,4,6,0,10,1,4,1,6,4,2,9,3,1,3,8,5,1,8,2,7,5,1,0,9,6,0,8,5,3,1,4,3,6,1,0,2,8,5,1,0,7,1,9,3,6,10,1,2,3,0,7,1,9,3,10,1,0,2,9,1,5,6,4,9,3,10,9,3,0,9,10,1,2,3,0,10,4,5,6,0,2,0,5,9,3,0,4,7,1,10,9,3,1,0],
    [0,2,1,4,6,3,0,5,0,1,0,4,2,3,1,0,2,5,1,4,3,6,4,2,1,9,3,2,4,5,3,6,1,4,2,3,0,5,10,1,3,1,5,8,6,0,4,3,6,1,2,0,5,4,3,2,4,7,1,3,0,1,2,0,10,1,7,2,9,5,1,7,3,0,6,1,7,2,3,5,1,7,2,6,0,3,6,4,2,3,1,0,4,2,3,5,1,4,2,0,1,0,6,0,3,1,6,4,2,3,1,0,4,2,3,5,1,4,2,0,1,0,6,5,1,0,1,5,4,6,2,3,1,6,0,5,4,6,1,3,0,4,7,1,2,9,3,5,1,6,0,0,0],
    [0,6,0,1,5,1,5,4,2,1,3,1,0,5,1,2,3,0,5,6,0,4,3,8,5,1,2,3,11,5,0,8,5,2,1,3,2,4,5,3,0,4,2,3,8,3,0,5,4,7,1,8,5,2,4,3,0,6,0,5,7,1,4,3,6,1,4,2,0,6,3,2,4,6,0,4,7,1,4,3,1,7,1,2,5,6,0,0,3,4,2,6,0,2,9,3,6,0,7,5,2,1,4,2,3,1,0,0,0],
    [0,4,8,5,4,1,3,9,4,8,0,3,4,8,5,1,0,3,6,0,5,7,1,2,8,5,4,3,0,6,1,10,4,3,9,4,5,1,7,3,2,4,6,0,2,1,8,5,1,0,5,3,1,0,4,5,1,3,2,1,4,10,8,1,2,3,0,8,5,4,3,0,1,8,2,4,5,1,2,0,8,5,1,0,4,0,3,0,5,3,2,4,9,3,0,4,8,1,5,6,0,1,5,4,9,3,11,0,1,6,8,5,3,5,1,7,4,3,6,0,10,1,7,4,6,3,4,1,3,6,9,3,0,3,1,0]
];

const SAMPLE_LABELS = [
    '0 - June 23, 2021',
    '1 - June 30, 2021',
    '2 - July 3, 2021',
    '3 - July 10, 2021',
    '4 - July 24, 2021',
    '5 - July 31, 2021',
    '6 - August 14, 2021',
    '7 - August 28, 2021',
    '8 - September 5, 2021'
];

// ============================================================
// music21-equivalent utilities
// ============================================================

const LETTER_TO_SEMITONE = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
const SEMITONE_TO_NOTE = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

function parseTiulName(name) {
    const upper = name.toUpperCase();
    const letter = upper[0];
    const rest = upper.slice(1);
    let accSemitones = 0;
    for (const ch of rest) {
        if (ch === '#') accSemitones++;
        else if (ch === '-') accSemitones--;
    }
    let display = letter;
    if (accSemitones > 0) display += '#'.repeat(accSemitones);
    else if (accSemitones < 0) display += 'b'.repeat(-accSemitones);
    return { letter, accSemitones, displayName: display };
}

function tiulNameToMidi(name, octave) {
    const parsed = parseTiulName(name);
    const base = LETTER_TO_SEMITONE[parsed.letter];
    if (base === undefined) return 60;
    return (octave + 1) * 12 + base + parsed.accSemitones;
}

function midiToSoundfontName(midi) {
    const octave = Math.floor(midi / 12) - 1;
    const noteIndex = ((midi % 12) + 12) % 12;
    return SEMITONE_TO_NOTE[noteIndex] + octave;
}

function weightedChoice(items, weights) {
    const total = weights.reduce((a, b) => a + b, 0);
    if (total === 0) return items[0];
    let r = Math.random() * total;
    for (let i = 0; i < items.length; i++) {
        r -= weights[i];
        if (r <= 0) return items[i];
    }
    return items[items.length - 1];
}

// Key transposition offsets (semitones from C)
const KEY_OFFSETS = {
    'C': 0, 'C#': 1, 'D-': 1, 'D': 2, 'D#': 3, 'E-': 3, 'E': 4, 'F': 5,
    'F#': 6, 'G-': 6, 'G': 7, 'G#': 8, 'A-': 8, 'A': 9, 'A#': 10, 'B-': 10, 'B': 11, 'B#': 0, 'C-': 11
};

// MIDI degree indices: maps pitch class (0-11) to degree index in KEY_DEGREES
//   1=0  5=7  3=4  2=2  4=5  6=9  7=11  4+=6  7-=10  3-=3  6-=8  1+=1
const MIDI_DEGREES = [0, 7, 4, 2, 5, 9, 11, 6, 10, 3, 8, 1];

// MIDI chord pairs from the original C major diad analysis (SAMPLE_DOUBLE_5_MIDI)
const SAMPLE_DOUBLE_5_MIDI = [[60,64],[60,65],[60,67],[60,69],[62,69],[64,69],[65,69],[65,72],[64,72],[64,71],[62,71],[62,69],[62,65],[59,65],[56,65],[55,65],[55,64],[55,62],[59,62],[59,65],[60,64],[60,67],[60,69],[60,71],[60,72],[62,72],[64,72],[64,71],[65,69],[62,69],[59,69],[59,67],[59,65],[60,64],[58,64],[57,65],[55,65],[55,64],[55,62],[59,62],[59,65],[60,64],[60,72],[60,71],[60,69],[60,67],[60,62],[59,62],[55,62],[55,65],[57,65],[59,65],[60,64],[60,64],[60,65],[60,67],[60,69],[62,69],[64,69],[65,69],[65,67],[64,67],[64,65],[62,65],[62,64],[60,64],[59,64],[57,64],[57,65],[64,65],[62,65],[62,69],[64,69],[64,72],[67,72],[67,71],[65,71],[64,72],[65,72],[67,72],[69,72],[69,71],[67,71],[65,69],[62,69],[59,69],[59,67],[59,65],[60,64],[57,64],[57,59],[55,59],[53,59],[53,62],[57,64],[55,64],[59,64],[59,65],[60,64],[60,64],[60,65],[60,67],[65,67],[64,67],[62,67],[62,69],[62,71],[67,71],[65,71],[64,71],[62,71],[62,69],[62,65],[62,64],[60,64],[57,64],[55,64],[57,62],[55,62],[59,62],[60,64],[60,67],[66,67],[65,67],[64,67],[64,72],[64,71],[62,67],[60,67],[60,62],[59,62],[59,65],[60,64],[61,69],[62,69],[62,71],[62,72],[64,72],[66,72],[67,71],[64,71],[60,71],[60,69],[60,67],[60,66],[59,67],[55,67],[57,66],[57,65],[55,65],[55,64],[55,62],[59,62],[59,67],[59,69],[60,69],[62,69],[62,67],[62,65],[62,64],[60,64],[59,64],[60,64],[60,64],[60,67],[60,65],[65,69],[65,67],[64,67],[64,65],[62,65],[59,65],[59,64],[60,69],[62,71],[64,72],[66,72],[67,71],[64,71],[62,71],[62,64],[60,64],[57,64],[56,64],[55,64],[55,62],[59,62],[59,65],[60,64],[60,69],[62,69],[62,71],[62,72],[66,72],[67,71],[67,74],[67,76],[65,76],[65,74],[64,74],[64,72],[64,71],[64,67],[62,67],[59,67],[59,65],[60,64],[57,64],[57,65],[62,65],[59,65],[60,64],[57,64],[56,64],[55,64],[55,62],[60,67],[60,64],[60,65],[62,65],[62,67],[64,67],[64,72],[64,71],[64,69],[64,67],[64,65],[62,65],[59,65],[60,64],[57,64],[57,65],[57,66],[57,67],[59,67],[60,67],[60,64],[59,64],[57,64],[55,64],[60,64],[60,65],[60,66],[59,67],[67,71],[65,71],[64,72],[66,72],[67,72],[67,71],[67,69],[66,69],[62,69],[62,64],[60,64],[57,64],[57,65],[59,65],[55,65],[60,64],[64,72],[64,71],[64,69],[64,67],[64,65],[62,65],[59,65],[55,65],[57,65],[60,64],[60,63],[57,63],[53,63],[54,60],[55,59],[56,59],[57,60],[57,62],[57,65],[59,65],[60,64],[72,76],[71,76],[69,76],[69,74],[69,72],[69,71],[67,71],[65,71],[64,69],[63,69],[62,72],[62,71],[67,71],[65,71],[64,71],[64,65],[62,65],[62,71],[62,69],[62,67],[62,66],[60,66],[59,66],[60,67],[64,67],[64,69],[67,71],[64,72],[65,72],[67,72],[67,71],[67,74],[67,76],[69,76],[69,72],[69,71],[67,71],[65,71],[64,72],[63,72],[62,72],[67,71],[67,72],[67,74],[72,76],[71,76],[71,74],[71,72],[69,72],[65,72],[64,72],[62,71],[60,72],[72,76],[71,76],[69,76],[69,71],[67,71],[64,71],[64,65],[62,65],[62,71],[62,69],[61,69],[60,69],[62,67],[62,65],[62,71],[62,69],[62,71],[64,72],[65,72],[65,69],[65,74],[67,74],[67,76],[69,76],[69,74],[68,74],[67,71],[65,71],[64,72],[64,65],[62,65],[61,65],[60,65],[60,67],[65,69],[65,72],[64,72],[63,72],[62,72],[62,71],[67,71],[67,74],[67,77],[69,77],[71,77],[72,76],[73,76],[73,79],[74,77],[72,77],[71,77],[72,76],[70,76],[69,76],[69,77],[69,76],[69,74],[66,74],[66,72],[67,71],[64,71],[62,71],[62,72],[66,72],[67,71],[60,67],[64,67],[64,69],[65,69],[65,72],[65,74],[71,74],[71,72],[69,72],[69,71],[67,71],[67,70],[67,69],[65,69],[64,69],[63,69],[62,69],[67,71],[67,74],[71,74],[71,77],[72,76],[69,76],[69,72],[67,72],[67,71],[64,72],[64,65],[62,65],[62,69],[62,70],[62,71],[64,72],[64,74],[66,74],[67,71],[67,74],[67,76],[72,76],[72,74],[71,74],[71,72],[69,72],[66,72],[67,71],[64,70],[65,69],[64,69],[62,69],[59,69],[59,67],[59,65],[60,64],[60,62],[59,62],[55,62],[55,60],[55,59],[53,59],[52,60],[50,60],[50,59],[48,60]];

function buildTransitionMatrix(sample, size) {
    const matrix = [];
    for (let i = 0; i < size; i++) {
        matrix.push(new Array(size).fill(0));
    }
    for (let i = 0; i < sample.length - 1; i++) {
        matrix[sample[i]][sample[i + 1]]++;
    }
    for (let i = 0; i < size; i++) {
        const rowSum = matrix[i].reduce((a, b) => a + b, 0);
        if (rowSum > 0) {
            for (let j = 0; j < size; j++) {
                matrix[i][j] = matrix[i][j] / rowSum;
            }
        }
    }
    return matrix;
}
